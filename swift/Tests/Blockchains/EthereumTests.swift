// Copyright Â© 2017-2022 Trust Wallet.
//
// This file is part of Trust. The full Trust copyright notice, including
// terms governing use, modification, and redistribution, is contained in the
// file LICENSE at the root of the source code distribution tree.

import XCTest
import WalletCore

class EthereumTests: XCTestCase {
    
    func testAddress() {
        let anyAddress = AnyAddress(string: "0x7d8bf18c7ce84b3e175b339c4ca93aed1dd166f1", coin: .ethereum)

        XCTAssertEqual(anyAddress?.description, "0x7d8bf18C7cE84b3E175b339c4Ca93aEd1dD166F1")
        XCTAssertEqual(anyAddress?.coin, .ethereum)

        let invalid = "0xMQqpqMQgCBuiPkoXfgZZsJvuzCeI1zc00z6vHJj4"
        XCTAssertNil(Data(hexString: invalid))
        XCTAssertNil(AnyAddress(string: invalid, coin: .ethereum))
        XCTAssertFalse(AnyAddress.isValid(string: invalid, coin: .ethereum))
    }

    func testSigner() throws {
        let input = EthereumSigningInput.with {
            $0.chainID = Data(hexString: "01")!
            $0.nonce = Data(hexString: "09")!
            // txMode not set, Legacy is the default
            $0.gasPrice = Data(hexString: "04a817c800")!
            $0.gasLimit = Data(hexString: "5208")!
            $0.toAddress = "0x3535353535353535353535353535353535353535"
            $0.privateKey = Data(hexString: "0x4646464646464646464646464646464646464646464646464646464646464646")!
            $0.transaction = EthereumTransaction.with {
                $0.transfer = EthereumTransaction.Transfer.with {
                    $0.amount = Data(hexString: "0de0b6b3a7640000")!
                }
            }
        }

        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)

        XCTAssertEqual(try input.serializedData().hexString, "0a0101120109220504a817c8002a025208422a3078333533353335333533353335333533353335333533353335333533353335333533353335333533354a204646464646464646464646464646464646464646464646464646464646464646520c0a0a0a080de0b6b3a7640000")
        XCTAssertEqual(output.encoded.hexString, "f86c098504a817c800825208943535353535353535353535353535353535353535880de0b6b3a76400008025a028ef61340bd939bc2195fe537567866003e1a15d3c71ff63e1590620aa636276a067cbe9d8997f761aecb703304b3800ccf555c9f3dc64214b297fb1966a3b6d83")
    }

    func testSignERC20Transfer() {
        let input = EthereumSigningInput.with {
            $0.chainID = Data(hexString: "01")!
            $0.nonce = Data(hexString: "00")!
            // txMode not set, Legacy is the default
            $0.gasPrice = Data(hexString: "09c7652400")! // 42000000000
            $0.gasLimit = Data(hexString: "0130B9")! // 78009
            $0.toAddress = "0x6b175474e89094c44da98b954eedeac495271d0f" // DAI
            $0.privateKey = Data(hexString: "0x608dcb1742bb3fb7aec002074e3420e4fab7d00cced79ccdac53ed5b27138151")!
            $0.transaction = EthereumTransaction.with {
                $0.erc20Transfer = EthereumTransaction.ERC20Transfer.with {
                    $0.to = "0x5322b34c88ed0691971bf52a7047448f0f4efc84"
                    $0.amount = Data(hexString: "1bc16d674ec80000")! // 2000000000000000000
                }
            }
        }
        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)

        XCTAssertEqual(output.encoded.hexString, "f8aa808509c7652400830130b9946b175474e89094c44da98b954eedeac495271d0f80b844a9059cbb0000000000000000000000005322b34c88ed0691971bf52a7047448f0f4efc840000000000000000000000000000000000000000000000001bc16d674ec8000025a0724c62ad4fbf47346b02de06e603e013f26f26b56fdc0be7ba3d6273401d98cea0032131cae15da7ddcda66963e8bef51ca0d9962bfef0547d3f02597a4a58c931")
        XCTAssertEqual(output.data.hexString, "a9059cbb0000000000000000000000005322b34c88ed0691971bf52a7047448f0f4efc840000000000000000000000000000000000000000000000001bc16d674ec80000")
    }

    func testSignERC20Transfer_1559() {
        let input = EthereumSigningInput.with {
            $0.chainID = Data(hexString: "01")!
            $0.nonce = Data(hexString: "00")!
            $0.txMode = .enveloped
            $0.gasLimit = Data(hexString: "0130B9")! // 78009
            $0.maxInclusionFeePerGas = Data(hexString: "0077359400")! // 2000000000
            $0.maxFeePerGas = Data(hexString: "00B2D05E00")! // 3000000000
            $0.toAddress = "0x6b175474e89094c44da98b954eedeac495271d0f" // DAI
            $0.privateKey = Data(hexString: "0x608dcb1742bb3fb7aec002074e3420e4fab7d00cced79ccdac53ed5b27138151")!
            $0.transaction = EthereumTransaction.with {
                $0.erc20Transfer = EthereumTransaction.ERC20Transfer.with {
                    $0.to = "0x5322b34c88ed0691971bf52a7047448f0f4efc84"
                    $0.amount = Data(hexString: "1bc16d674ec80000")! // 2000000000000000000
                }
            }
        }
        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)

        XCTAssertEqual(output.encoded.hexString, "02f8b00180847735940084b2d05e00830130b9946b175474e89094c44da98b954eedeac495271d0f80b844a9059cbb0000000000000000000000005322b34c88ed0691971bf52a7047448f0f4efc840000000000000000000000000000000000000000000000001bc16d674ec80000c080a0adfcfdf98d4ed35a8967a0c1d78b42adb7c5d831cf5a3272654ec8f8bcd7be2ea011641e065684f6aa476f4fd250aa46cd0b44eccdb0a6e1650d658d1998684cdf")
    }

    func testSignERC20Approve() {
        let input = EthereumSigningInput.with {
            $0.chainID = Data(hexString: "01")!
            $0.nonce = Data(hexString: "00")!
            // txMode not set, Legacy is the default
            $0.gasPrice = Data(hexString: "09c7652400")! // 42000000000
            $0.gasLimit = Data(hexString: "0130B9")! // 78009
            $0.toAddress = "0x6b175474e89094c44da98b954eedeac495271d0f" // DAI
            $0.privateKey = Data(hexString: "0x608dcb1742bb3fb7aec002074e3420e4fab7d00cced79ccdac53ed5b27138151")!
            $0.transaction = EthereumTransaction.with {
                $0.erc20Approve = EthereumTransaction.ERC20Approve.with {
                    $0.spender = "0x5322b34c88ed0691971bf52a7047448f0f4efc84"
                    $0.amount = Data(hexString: "1bc16d674ec80000")! // 2000000000000000000
                }
            }
        }
        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)

        XCTAssertEqual(output.encoded.hexString, "f8aa808509c7652400830130b9946b175474e89094c44da98b954eedeac495271d0f80b844095ea7b30000000000000000000000005322b34c88ed0691971bf52a7047448f0f4efc840000000000000000000000000000000000000000000000001bc16d674ec8000025a0d8136d66da1e0ba8c7208d5c4f143167f54b89a0fe2e23440653bcca28b34dc1a049222a79339f1a9e4641cb4ad805c49c225ae704299ffc10627bf41c035c464a")
    }

    func testSignERC721Transfer() {
        // https://etherscan.io/tx/0x3cde660762810d951d5cc57f8d907fbf229054908f1a770c3fb0b7b375cf4f82
        // real key 1p
        let input = EthereumSigningInput.with {
            $0.chainID = Data(hexString: "01")!
            $0.nonce = Data(hexString: "02de")! // 734
            // txMode not set, Legacy is the default
            $0.gasPrice = Data(hexString: "22ecb25c00")! // 150000000000
            $0.gasLimit = Data(hexString: "0130b9")! // 78009
            $0.toAddress = "0x0d8c864DA1985525e0af0acBEEF6562881827bd5" // contract
            $0.privateKey = Data(hexString: "0x608dcb1742bb3fb7aec002074e3420e4fab7d00cced79ccdac53ed5b27138151")!
            $0.transaction = EthereumTransaction.with {
                $0.erc721Transfer = EthereumTransaction.ERC721Transfer.with {
                    $0.from = "0x7d8bf18C7cE84b3E175b339c4Ca93aEd1dD166F1"
                    $0.to = "0x47331175b23C2f067204B506CA1501c26731C990"
                    $0.tokenID = Data(hexString: "0fd8")! // 4056
                }
            }
        }
        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)

        XCTAssertEqual(output.encoded.hexString, "f8cc8202de8522ecb25c00830130b9940d8c864da1985525e0af0acbeef6562881827bd580b86423b872dd0000000000000000000000007d8bf18c7ce84b3e175b339c4ca93aed1dd166f100000000000000000000000047331175b23c2f067204b506ca1501c26731c9900000000000000000000000000000000000000000000000000000000000000fd825a04c5d8242a8c2db1cfa352a3486dd85c82824e01b9bcf0ce4170fcd2329fb7bcaa02d85ab09e750a73fd4dd26b142830ada1e991f8474795b43d96d93e65caaefe7")
        XCTAssertEqual(output.data.hexString, "23b872dd0000000000000000000000007d8bf18c7ce84b3e175b339c4ca93aed1dd166f100000000000000000000000047331175b23c2f067204b506ca1501c26731c9900000000000000000000000000000000000000000000000000000000000000fd8")
    }

    func testSignERC1155Transfer() {
        let input = EthereumSigningInput.with {
            $0.chainID = Data(hexString: "01")!
            $0.nonce = Data(hexString: "00")!
            // txMode not set, Legacy is the default
            $0.gasPrice = Data(hexString: "09C7652400")! // 42000000000
            $0.gasLimit = Data(hexString: "0130b9")! // 78009
            $0.toAddress = "0x4e45e92ed38f885d39a733c14f1817217a89d425" // contract
            $0.privateKey = Data(hexString: "0x608dcb1742bb3fb7aec002074e3420e4fab7d00cced79ccdac53ed5b27138151")!
            $0.transaction = EthereumTransaction.with {
                $0.erc1155Transfer = EthereumTransaction.ERC1155Transfer.with {
                    $0.from = "0x718046867b5b1782379a14eA4fc0c9b724DA94Fc"
                    $0.to = "0x5322b34c88ed0691971bf52a7047448f0f4efc84"
                    $0.tokenID = Data(hexString: "0x23c47ee5")!
                    $0.value = Data(hexString: "0x1BC16D674EC80000")! // 2000000000000000000
                    $0.data = Data(hexString: "0x01020304")!
                }
            }
        }
        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)

        XCTAssertEqual(output.encoded.hexString, "f9014a808509c7652400830130b9944e45e92ed38f885d39a733c14f1817217a89d42580b8e4f242432a000000000000000000000000718046867b5b1782379a14ea4fc0c9b724da94fc0000000000000000000000005322b34c88ed0691971bf52a7047448f0f4efc840000000000000000000000000000000000000000000000000000000023c47ee50000000000000000000000000000000000000000000000001bc16d674ec8000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000004010203040000000000000000000000000000000000000000000000000000000026a010315488201ac801ce346bffd1570de147615462d7e7db3cf08cf558465c6b79a06643943b24593bc3904a9fda63bb169881730994c973ab80f07d66a698064573")
        XCTAssertEqual(output.data.hexString, "f242432a000000000000000000000000718046867b5b1782379a14ea4fc0c9b724da94fc0000000000000000000000005322b34c88ed0691971bf52a7047448f0f4efc840000000000000000000000000000000000000000000000000000000023c47ee50000000000000000000000000000000000000000000000001bc16d674ec8000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000040102030400000000000000000000000000000000000000000000000000000000")
    }

    func testSignStakeRocketPool() {
        let function = EthereumAbiFunction(name: "deposit")

        let input = EthereumSigningInput.with {
            $0.chainID = Data(hexString: "01")!
            $0.nonce = Data(hexString: "01")!
            $0.txMode = .enveloped
            $0.gasPrice = Data(hexString: "77541880")! // 2002000000
            $0.gasLimit = Data(hexString: "0320c8")! // 205000
            $0.maxFeePerGas = Data(hexString: "067ef83700")! // 27900000000
            $0.maxInclusionFeePerGas = Data(hexString: "3b9aca00")! // 1000000000
            $0.toAddress = "0x2cac916b2a963bf162f076c0a8a4a8200bcfbfb4" // contract
            $0.privateKey = Data(hexString: "9f56448d33de406db1561aae15fce64bdf0e9706ff15c45d4409e8fcbfd1a498")!

            $0.transaction = EthereumTransaction.with {
                $0.transfer = EthereumTransaction.Transfer.with {
                    $0.amount = Data(hexString: "2386f26fc10000")! // 0.01 ETH
                    $0.data = Data(hexString: EthereumAbi.encode(fn: function).hexString)!
                }
            }
        }
        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)

        // https://etherscan.io/tx/0xfeba0c579f3e964fbc4eafa500e86891b9f4113735b1364edd4433d765506f1e
        XCTAssertEqual(output.r.hexString, "fb39e5079d7a0598ec45785d73a06b91fe1db707b9c6a150c87ffce2492c66d6")
        XCTAssertEqual(output.v.hexString, "00")
        XCTAssertEqual(output.s.hexString, "7fbd43a6f4733b2b4f98ad1bc4678ea2615f5edf56ad91408337adec2f07c0ac")
        XCTAssertEqual(output.encoded.hexString, "02f8770101843b9aca0085067ef83700830320c8942cac916b2a963bf162f076c0a8a4a8200bcfbfb4872386f26fc1000084d0e30db0c080a0fb39e5079d7a0598ec45785d73a06b91fe1db707b9c6a150c87ffce2492c66d6a07fbd43a6f4733b2b4f98ad1bc4678ea2615f5edf56ad91408337adec2f07c0ac")
    }

    func testSignUnstakeRocketPool() {
        let function = EthereumAbiFunction(name: "burn")
        function.addParamUInt256(val: Data(hexString: "0x21faa32ab2502b")!, isOutput: false)

        let input = EthereumSigningInput.with {
            $0.chainID = Data(hexString: "01")!
            $0.nonce = Data(hexString: "03")!
            $0.txMode = .enveloped
            $0.gasPrice = Data(hexString: "77541880")! // 2002000000
            $0.gasLimit = Data(hexString: "055730")! // 350000
            $0.maxFeePerGas = Data(hexString: "067ef83700")! // 27900000000
            $0.maxInclusionFeePerGas = Data(hexString: "3b9aca00")! // 1000000000
            $0.toAddress = "0xae78736Cd615f374D3085123A210448E74Fc6393" // contract
            $0.privateKey = Data(hexString: "9f56448d33de406db1561aae15fce64bdf0e9706ff15c45d4409e8fcbfd1a498")!

            $0.transaction = EthereumTransaction.with {
                $0.contractGeneric = EthereumTransaction.ContractGeneric.with {
                    $0.amount = Data(hexString: "00")!
                    $0.data = Data(hexString: EthereumAbi.encode(fn: function).hexString)!
                }
            }
        }
        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)

        // https://etherscan.io/tx/0x7fd3c0e9b8b309b4258baa7677c60f5e00e8db7b647fbe3a52adda25058a4b37
        XCTAssertEqual(output.r.hexString, "1fc6e94908107584357799e952b4e3fb87f088aeb66d7930a7015643f19c9e7f")
        XCTAssertEqual(output.v.hexString, "00")
        XCTAssertEqual(output.s.hexString, "2c56a0b70ff2e52bf374a3dcd404bc42317d5ca15d319f5e33665352eb48f06f")
        XCTAssertEqual(output.encoded.hexString, "02f8900103843b9aca0085067ef837008305573094ae78736cd615f374d3085123a210448e74fc639380a442966c680000000000000000000000000000000000000000000000000021faa32ab2502bc080a01fc6e94908107584357799e952b4e3fb87f088aeb66d7930a7015643f19c9e7fa02c56a0b70ff2e52bf374a3dcd404bc42317d5ca15d319f5e33665352eb48f06f")
    }

    func testSignJSON() {
        let json = """
        {
            "chainId": "AQ==",
            "gasPrice": "1pOkAA==",
            "gasLimit": "Ugg=",
            "toAddress": "0x7d8bf18C7cE84b3E175b339c4Ca93aEd1dD166F1",
            "transaction": {
                "transfer": {
                    "amount":"A0i8paFgAA=="
                }
            }
        }
        """
        let key = Data(hexString: "17209af590a86462395d5881e60d11c7fa7d482cfb02b5a01b93c2eeef243543")!
        let result = AnySigner.signJSON(json, key: key, coin: .ethereum)

        XCTAssertEqual(result, "f86a8084d693a400825208947d8bf18c7ce84b3e175b339c4ca93aed1dd166f1870348bca5a160008025a0fe5802b49e04c6b1705088310e133605ed8b549811a18968ad409ea02ad79f21a05bf845646fb1e1b9365f63a7fd5eb5e984094e3ed35c3bed7361aebbcbf41f10")
    }

    func testGetPublicKeyFromXpub() throws {
        let wallet = HDWallet(mnemonic: "broom ramp luggage this language sketch door allow elbow wife moon impulse", passphrase: "")!
        let path = "m/44'/60'/0'/0/1"
        let xpub = wallet.getExtendedPublicKey(purpose: .bip44, coin: .ethereum, version: .xpub)

        XCTAssertEqual(xpub, "xpub6C7LtZJgtz1BKXG9mExKUxYvX7HSF38UMMmGbpqNQw3DfYwAw8E6sH7VSVxFipvEEm2afSqTjoRgcLmycXX4zfxCWJ4HY73a9KdgvfHEQGB")

        let key = wallet.getKey(coin: .ethereum, derivationPath: path)
        let pubkey = key.getPublicKeySecp256k1(compressed: true)
        XCTAssertEqual(pubkey.data.hexString, "024516c4aa5352035e1bb5be132694e1389a4ac37d32e5e717d35ee4c4dfab5132")

        let pubkey2 = HDWallet.getPublicKeyFromExtended(extended: xpub, coin: .ethereum, derivationPath: path)!
        XCTAssertEqual(pubkey2.data.hexString, "044516c4aa5352035e1bb5be132694e1389a4ac37d32e5e717d35ee4c4dfab513226a9d14ea37a55962ad3644a08e2ce551b4495beabb9b09e688c7b92eba18acc")

        let address = CoinType.ethereum.deriveAddressFromPublicKey(publicKey: pubkey2)
        XCTAssertEqual(address, "0x996891c410FB76C19DBA72C6f6cEFF2d9DD069b1")
    }

    func testSpanishMnemonic() throws {
        let mnemonic = "llanto radical atraer riesgo actuar masa fondo cielo dieta archivo sonrisa mamut"
        XCTAssertNil(HDWallet(mnemonic: mnemonic, passphrase: ""))

        let wallet = HDWallet(mnemonic: mnemonic, passphrase: "", check: false)!
        let btcXpub = wallet.getExtendedPublicKey(purpose: .bip44, coin: .bitcoin, version: .xpub)
        let ethXpub = wallet.getExtendedPublicKey(purpose: .bip44, coin: .ethereum, version: .xpub)

        XCTAssertEqual(btcXpub, "xpub6Cq43Vqyvb2DwXzjzNeMpPuxXRCN1WnmRCmYLPaaSv2XZXM2yCwUHpWEyB3zQ3FGCQsvY21gecMaQR7b2zhhgiHnjzDYpKCE2LACueaSMuR")
        XCTAssertEqual(ethXpub, "xpub6Bgma7boPVudhExmB97iySvatGfnXkfBxYZYNTFYJvVzigUPk1X2iE8VhJPPxVuzjH8wBuTqRBMKCbwMYQNLrFCwYzMugYw4RM5VGNeVDpp")

        let ethAddress = wallet.getAddressForCoin(coin: .ethereum)
        let btcAddress = wallet.getAddressForCoin(coin: .bitcoin)

        XCTAssertEqual(ethAddress, "0xa4531dE99E22B2166d340E7221669DF565c52024")
        XCTAssertEqual(btcAddress, "bc1q97jc0jdgsyvvhxydxxd6np8sa920c39l3qpscf")
    }
    
    func testMessageAndVerifySignerImmutableX() {
        let privateKey = PrivateKey(data: Data(hexString: "3b0a61f46fdae924007146eacb6db6642de7a5603ad843ec58e10331d89d4b84")!)!
        let msg = "Only sign this request if youâve initiated an action with Immutable X.\n\nFor internal use:\nbd717ba31dca6e0f3f136f7c4197babce5f09a9f25176044c0b3112b1b6017a3"
        let signature = EthereumMessageSigner.signMessageImmutableX(privateKey: privateKey, message: msg)
        XCTAssertEqual(signature, "32cd5a58f3419fc5db672e3d57f76199b853eda0856d491b38f557b629b0a0814ace689412bf354a1af81126d2749207dffae8ae8845160f33948a6b787e17ee01")
        let pubKey = privateKey.getPublicKey(coinType: .ethereum)
        XCTAssertTrue(EthereumMessageSigner.verifyMessage(pubKey: pubKey, message: msg, signature: signature))
    }
    
    func testMessageAndVerifySignerLegacy() {
        let privateKey = PrivateKey(data: Data(hexString: "03a9ca895dca1623c7dfd69693f7b4111f5d819d2e145536e0b03c136025a25d")!)!
        let msg = "Foo"
        let signature = EthereumMessageSigner.signMessage(privateKey: privateKey, message: msg)
        XCTAssertEqual(signature, "21a779d499957e7fd39392d49a079679009e60e492d9654a148829be43d2490736ec72bc4a5644047d979c3cf4ebe2c1c514044cf436b063cb89fc6676be71101b")
        let pubKey = privateKey.getPublicKey(coinType: .ethereum)
        XCTAssertTrue(EthereumMessageSigner.verifyMessage(pubKey: pubKey, message: msg, signature: signature))
    }
    
    func testMessageAndVerifySignerEip155() {
        let privateKey = PrivateKey(data: Data(hexString: "03a9ca895dca1623c7dfd69693f7b4111f5d819d2e145536e0b03c136025a25d")!)!
        let msg = "Foo"
        let signature = EthereumMessageSigner.signMessageEip155(privateKey: privateKey, message: msg, chainId: 0)
        XCTAssertEqual(signature, "21a779d499957e7fd39392d49a079679009e60e492d9654a148829be43d2490736ec72bc4a5644047d979c3cf4ebe2c1c514044cf436b063cb89fc6676be711023")
        let pubKey = privateKey.getPublicKey(coinType: .ethereum)
        XCTAssertTrue(EthereumMessageSigner.verifyMessage(pubKey: pubKey, message: msg, signature: signature))
    }
    
    func testMessageAndVerifySigner712Legacy() {
        let privateKey = PrivateKey(data: Data(hexString: "03a9ca895dca1623c7dfd69693f7b4111f5d819d2e145536e0b03c136025a25d")!)!
        let msg = """
         {
                        "types": {
                            "EIP712Domain": [
                                {"name": "name", "type": "string"},
                                {"name": "version", "type": "string"},
                                {"name": "chainId", "type": "uint256"},
                                {"name": "verifyingContract", "type": "address"}
                            ],
                            "Person": [
                                {"name": "name", "type": "string"},
                                {"name": "wallet", "type": "address"}
                            ]
                        },
                        "primaryType": "Person",
                        "domain": {
                            "name": "Ether Person",
                            "version": "1",
                            "chainId": 0,
                            "verifyingContract": "0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC"
                        },
                        "message": {
                            "name": "Cow",
                            "wallet": "CD2a3d9F938E13CD947Ec05AbC7FE734Df8DD826"
                        }
                    }
        """
        let signature = EthereumMessageSigner.signTypedMessage(privateKey: privateKey, messageJson: msg)
        XCTAssertEqual(signature, "446434e4c34d6b7456e5f07a1b994b88bf85c057234c68d1e10c936b1c85706c4e19147c0ac3a983bc2d56ebfd7146f8b62bcea6114900fe8e7d7351f44bf3761c")
        let pubKey = privateKey.getPublicKey(coinType: .ethereum)
        XCTAssertTrue(EthereumMessageSigner.verifyMessage(pubKey: pubKey, message: msg, signature: signature))
    }
    
    func testMessageAndVerifySigner712Eip155() {
        let privateKey = PrivateKey(data: Data(hexString: "03a9ca895dca1623c7dfd69693f7b4111f5d819d2e145536e0b03c136025a25d")!)!
        let msg = """
         {
                        "types": {
                            "EIP712Domain": [
                                {"name": "name", "type": "string"},
                                {"name": "version", "type": "string"},
                                {"name": "chainId", "type": "uint256"},
                                {"name": "verifyingContract", "type": "address"}
                            ],
                            "Person": [
                                {"name": "name", "type": "string"},
                                {"name": "wallet", "type": "address"}
                            ]
                        },
                        "primaryType": "Person",
                        "domain": {
                            "name": "Ether Person",
                            "version": "1",
                            "chainId": 0,
                            "verifyingContract": "0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC"
                        },
                        "message": {
                            "name": "Cow",
                            "wallet": "CD2a3d9F938E13CD947Ec05AbC7FE734Df8DD826"
                        }
                    }
        """
        let signature = EthereumMessageSigner.signTypedMessageEip155(privateKey: privateKey, messageJson: msg, chainId: 0)
        XCTAssertEqual(signature, "446434e4c34d6b7456e5f07a1b994b88bf85c057234c68d1e10c936b1c85706c4e19147c0ac3a983bc2d56ebfd7146f8b62bcea6114900fe8e7d7351f44bf37624")
        let pubKey = privateKey.getPublicKey(coinType: .ethereum)
        XCTAssertTrue(EthereumMessageSigner.verifyMessage(pubKey: pubKey, message: msg, signature: signature))
    }

    // EIP4337

    func testEIP4337DeploymentAddressFromOwnerBytes() {
        let factoryAddress = "0xb7f8bc63bbcad18155201308c8f3540b07f84f5e"
        let bytecode = "0x60808060405261127d80380380916100178285610943565b833981019060e0818303126108de5761002f81610966565b9161003c60208301610966565b9161004960408201610966565b9161005660608301610966565b9161006360808201610966565b61006f60a08301610966565b60c083015190926001600160401b0382116108de570183601f820112156108de57805161009b8161097a565b946100a96040519687610943565b818652602082840101116108de576100c79160208087019101610995565b604051633253960f60e01b815260208160048160006001600160a01b038b165af19081156108eb576000916108a3575b506001600160e01b031981161561085f576040979695975196610119886108f7565b6002885260005b6040811061082b57509161026693916102749695936040519061014282610928565b60018252602036818401376040519161015a83610928565b60018352602036818501376307e4c70760e21b610176826109b8565b5260405191610184836108f7565b6001600160a01b031682526000602083015260408201526101a48b6109b8565b526101ae8a6109b8565b506001600160e01b031982166101c3826109b8565b52604051906101d1826108f7565b6001600160a01b038c1682526000602083015260408201526101f28a6109db565b526101fc896109db565b506001805464ffffffff00191660d89290921c64ffffffff0016919091179055604051634a93641760e01b60208201526001600160a01b03958616602482015298851660448a015284166064890152909216608487015260a060a4870152859160c48301906109ff565b03601f198101855284610943565b6000915b805183101561070457602061028d84836109eb565b51015160038110156106ee578061041457506001600160a01b036102b184836109eb565b5151169160406102c185846109eb565b510151916102d183511515610a49565b6102dc841515610aa9565b6001600160a01b038416600090815260008051602061125d83398151915260205260409020546001600160601b0316918215610406575b6000925b84518410156103ec576001600160e01b031961033385876109eb565b5116600081815260008051602061121d83398151915260205260409020546001600160a01b031661038157816103708861037b9461037594610c3b565b610b0a565b93610a24565b92610317565b60405162461bcd60e51b815260206004820152603560248201527f4c69624469616d6f6e644375743a2043616e2774206164642066756e6374696f60448201527f6e207468617420616c72656164792065786973747300000000000000000000006064820152608490fd5b509491509492506103fe91505b610a24565b919092610278565b61040f85610b49565b610313565b9193916001810361058d57506001600160a01b0361043284836109eb565b51511693604061044285846109eb565b5101519161045283511515610a49565b61045d861515610aa9565b6001600160a01b038616600090815260008051602061125d83398151915260205260409020546001600160601b031691821561057f575b6000925b845184101561056f576001600160e01b03196104b485876109eb565b5116600081815260008051602061121d83398151915260205260409020546001600160a01b031691898314610504576103708a82846104f9610375966104fe98610d26565b610c3b565b92610498565b60405162461bcd60e51b815260206004820152603860248201527f4c69624469616d6f6e644375743a2043616e2774207265706c6163652066756e60448201527f6374696f6e20776974682073616d652066756e6374696f6e00000000000000006064820152608490fd5b5094915094506103fe9150610a24565b61058887610b49565b610494565b600203610699576001600160a01b036105a684836109eb565b5151169360406105b685846109eb565b510151946105c686511515610a49565b61062e5760005b85518110156106215761061c906103f96001600160e01b03196105f0838a6109eb565b5116600081815260008051602061121d83398151915260205260409020546001600160a01b0316610d26565b6105cd565b50926103fe919450610a24565b60405162461bcd60e51b815260206004820152603660248201527f4c69624469616d6f6e644375743a2052656d6f7665206661636574206164647260448201527f657373206d7573742062652061646472657373283029000000000000000000006064820152608490fd5b60405162461bcd60e51b815260206004820152602760248201527f4c69624469616d6f6e644375743a20496e636f727265637420466163657443756044820152663a20b1ba34b7b760c91b6064820152608490fd5b634e487b7160e01b600052602160045260246000fd5b8382604051606081016060825284518091526080820190602060808260051b8501019601916000905b828210610793576001600160a01b0386166020860152848803604086015261078587877f8faa70878671ccd212d20771b795c50af8fd3ff6cf27f4bde57e5d4de0aeb673888061077d8e866109ff565b0390a161101f565b60405160e2908161113b8239f35b848803607f19018152835180516001600160a01b03168952602081015194989394929391929060038210156106ee576040916020840152015190606060408201526020608060608301928451809452019201906000905b8082106108085750505060208060019299019201920190929161072d565b82516001600160e01b0319168452602093840193909201916001909101906107ea565b60209060409a98999a5161083e816108f7565b600081526000838201526060604082015282828d0101520198979698610120565b606460405162461bcd60e51b815260206004820152602060248201527f4261727a3a20496e76616c696420566572696669636174696f6e2046616365746044820152fd5b90506020813d6020116108e3575b816108be60209383610943565b810103126108de57516001600160e01b0319811681036108de57386100f7565b600080fd5b3d91506108b1565b6040513d6000823e3d90fd5b606081019081106001600160401b0382111761091257604052565b634e487b7160e01b600052604160045260246000fd5b604081019081106001600160401b0382111761091257604052565b601f909101601f19168101906001600160401b0382119082101761091257604052565b51906001600160a01b03821682036108de57565b6001600160401b03811161091257601f01601f191660200190565b60005b8381106109a85750506000910152565b8181015183820152602001610998565b8051156109c55760200190565b634e487b7160e01b600052603260045260246000fd5b8051600110156109c55760400190565b80518210156109c55760209160051b010190565b90602091610a1881518092818552858086019101610995565b601f01601f1916010190565b6000198114610a335760010190565b634e487b7160e01b600052601160045260246000fd5b15610a5057565b60405162461bcd60e51b815260206004820152602b60248201527f4c69624469616d6f6e644375743a204e6f2073656c6563746f727320696e206660448201526a1858d95d081d1bc818dd5d60aa1b6064820152608490fd5b15610ab057565b60405162461bcd60e51b815260206004820152602c60248201527f4c69624469616d6f6e644375743a204164642066616365742063616e2774206260448201526b65206164647265737328302960a01b6064820152608490fd5b6001600160601b03908116908114610a335760010190565b60008051602061123d83398151915280548210156109c55760005260206000200190600090565b610b95604051610b58816108f7565b602481527f4c69624469616d6f6e644375743a204e657720666163657420686173206e6f20602082015263636f646560e01b60408201528261110d565b60008051602061123d83398151915280546001600160a01b038316600090815260008051602061125d833981519152602052604090206001018190559190680100000000000000008310156109125782610bf7916001610c1695019055610b22565b90919082549060031b9160018060a01b03809116831b921b1916179055565b565b91909180548310156109c557600052601c60206000208360031c019260021b1690565b6001600160e01b03198116600081815260008051602061121d83398151915260208190526040822080546001600160a01b031660a09690961b6001600160a01b031916959095179094559194939092906001600160a01b031680835260008051602061125d8339815191526020526040832080549194919068010000000000000000821015610d125796610cdc8260409798996001610cf995018155610c18565b90919063ffffffff83549160031b9260e01c831b921b1916179055565b82526020522080546001600160a01b0319169091179055565b634e487b7160e01b85526041600452602485fd5b9091906001600160a01b039081168015610fb457308114610f585763ffffffff60e01b80941660009281845260008051602061121d833981519152926020918483526040948587205460a01c9083885260008051602061125d8339815191529586865287892054926000199b8c8501948511610f4457908991888c898c89808703610ed6575b505090525050508787525087892080548015610ec2578c0190610dcf8282610c18565b63ffffffff82549160031b1b191690555588528452868681205515610df9575b5050505050509050565b60008051602061123d8339815191528054898101908111610eae57838852858552826001888a20015491808303610e7c575b5050508054988915610e685760019798990191610e4783610b22565b909182549160031b1b19169055558552528220015580388080808080610def565b634e487b7160e01b88526031600452602488fd5b610e8590610b22565b90549060031b1c16610e9a81610bf784610b22565b885285855260018789200155388281610e2b565b634e487b7160e01b88526011600452602488fd5b634e487b7160e01b8b52603160045260248bfd5b610f379784610cdc93610ef58a9487610f0b9952828a52848420610c18565b90549060031b1c60e01b97889683525220610c18565b168b52838852898b2080546001600160a01b031660a09290921b6001600160a01b031916919091179055565b873880888c898c89610dac565b634e487b7160e01b8b52601160045260248bfd5b60405162461bcd60e51b815260206004820152602e60248201527f4c69624469616d6f6e644375743a2043616e27742072656d6f766520696d6d7560448201526d3a30b1363290333ab731ba34b7b760911b6064820152608490fd5b60405162461bcd60e51b815260206004820152603760248201527f4c69624469616d6f6e644375743a2043616e27742072656d6f76652066756e6360448201527f74696f6e207468617420646f65736e27742065786973740000000000000000006064820152608490fd5b6001600160a01b038116919082156111085760008091611085604051611044816108f7565b602881527f4c69624469616d6f6e644375743a205f696e6974206164647265737320686173602082015267206e6f20636f646560c01b60408201528261110d565b83519060208501905af4913d15611100573d926110a18461097a565b936110af6040519586610943565b84523d6000602086013e5b156110c457505050565b8251156110d357825160208401fd5b6110fc60405192839263192105d760e01b845260048401526040602484015260448301906109ff565b0390fd5b6060926110ba565b505050565b3b156111165750565b60405162461bcd60e51b8152602060048201529081906110fc9060248301906109ff56fe6080604052361560aa57600080356001600160e01b03191681527f183cde5d4f6bb7b445b8fc2f7f15d0fd1d162275aded24183babbffee7cd491f60205260408120546001600160a01b03168015606c57818091368280378136915af43d82803e156068573d90f35b3d90fd5b62461bcd60e51b6080526020608452602060a4527f4469616d6f6e643a2046756e6374696f6e20646f6573206e6f7420657869737460c45260646080fd5b00fea26469706673582212203df3feea7f1aa6ea31eb82d2ad84790e47617c094ced4ce17015a8a7487295da64736f6c63430008120033183cde5d4f6bb7b445b8fc2f7f15d0fd1d162275aded24183babbffee7cd491f183cde5d4f6bb7b445b8fc2f7f15d0fd1d162275aded24183babbffee7cd4921183cde5d4f6bb7b445b8fc2f7f15d0fd1d162275aded24183babbffee7cd4920"
        let diamondCutFacetAddress = "0xcf7ed3acca5a467e9e704c703e8d87f634fb0fc9"
        let accountFacetAddress = "0xdc64a140aa3e981100a9beca4e685f962f0cf6c9"
        let verificationFacetAddress = "0x5fc8d32690cc91d4c39d9d3abcbd16989f875707"
        let entryPointAddress = "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266"
        let securityManagerAddress = "0xe7f1725e7734ce288f8367e1bb143e90bb3f0512"
        let facetRegistryAddress = "0x9fe46736679d2d9a65f0992f2272de9f3c7fa6e0"
        let owner = "0x019b4ee7ad22ffd4c215e5f424faf4c75577dc36"

        let result = Ethereum.eip4337GetAddressFromOwnerBytes(factoryAddress: factoryAddress, bytecode: bytecode, diamondCutFacetAddress: diamondCutFacetAddress, accountFacetAddress: accountFacetAddress, verificationFacetAddress: verificationFacetAddress, entryPointAddress: entryPointAddress, securityManagerAddress: securityManagerAddress, facetRegistryAddress: facetRegistryAddress, owner: owner)
        XCTAssertEqual(result, "0xE9C377EFCE644fd54614d77C177c14148502496F")
    }

    func testEIP4337DeploymentAddressFromOwnerAttestationObject() {
        let factoryAddress = "0xb7f8bc63bbcad18155201308c8f3540b07f84f5e"
        let bytecode = "0x60808060405261127d80380380916100178285610943565b833981019060e0818303126108de5761002f81610966565b9161003c60208301610966565b9161004960408201610966565b9161005660608301610966565b9161006360808201610966565b61006f60a08301610966565b60c083015190926001600160401b0382116108de570183601f820112156108de57805161009b8161097a565b946100a96040519687610943565b818652602082840101116108de576100c79160208087019101610995565b604051633253960f60e01b815260208160048160006001600160a01b038b165af19081156108eb576000916108a3575b506001600160e01b031981161561085f576040979695975196610119886108f7565b6002885260005b6040811061082b57509161026693916102749695936040519061014282610928565b60018252602036818401376040519161015a83610928565b60018352602036818501376307e4c70760e21b610176826109b8565b5260405191610184836108f7565b6001600160a01b031682526000602083015260408201526101a48b6109b8565b526101ae8a6109b8565b506001600160e01b031982166101c3826109b8565b52604051906101d1826108f7565b6001600160a01b038c1682526000602083015260408201526101f28a6109db565b526101fc896109db565b506001805464ffffffff00191660d89290921c64ffffffff0016919091179055604051634a93641760e01b60208201526001600160a01b03958616602482015298851660448a015284166064890152909216608487015260a060a4870152859160c48301906109ff565b03601f198101855284610943565b6000915b805183101561070457602061028d84836109eb565b51015160038110156106ee578061041457506001600160a01b036102b184836109eb565b5151169160406102c185846109eb565b510151916102d183511515610a49565b6102dc841515610aa9565b6001600160a01b038416600090815260008051602061125d83398151915260205260409020546001600160601b0316918215610406575b6000925b84518410156103ec576001600160e01b031961033385876109eb565b5116600081815260008051602061121d83398151915260205260409020546001600160a01b031661038157816103708861037b9461037594610c3b565b610b0a565b93610a24565b92610317565b60405162461bcd60e51b815260206004820152603560248201527f4c69624469616d6f6e644375743a2043616e2774206164642066756e6374696f60448201527f6e207468617420616c72656164792065786973747300000000000000000000006064820152608490fd5b509491509492506103fe91505b610a24565b919092610278565b61040f85610b49565b610313565b9193916001810361058d57506001600160a01b0361043284836109eb565b51511693604061044285846109eb565b5101519161045283511515610a49565b61045d861515610aa9565b6001600160a01b038616600090815260008051602061125d83398151915260205260409020546001600160601b031691821561057f575b6000925b845184101561056f576001600160e01b03196104b485876109eb565b5116600081815260008051602061121d83398151915260205260409020546001600160a01b031691898314610504576103708a82846104f9610375966104fe98610d26565b610c3b565b92610498565b60405162461bcd60e51b815260206004820152603860248201527f4c69624469616d6f6e644375743a2043616e2774207265706c6163652066756e60448201527f6374696f6e20776974682073616d652066756e6374696f6e00000000000000006064820152608490fd5b5094915094506103fe9150610a24565b61058887610b49565b610494565b600203610699576001600160a01b036105a684836109eb565b5151169360406105b685846109eb565b510151946105c686511515610a49565b61062e5760005b85518110156106215761061c906103f96001600160e01b03196105f0838a6109eb565b5116600081815260008051602061121d83398151915260205260409020546001600160a01b0316610d26565b6105cd565b50926103fe919450610a24565b60405162461bcd60e51b815260206004820152603660248201527f4c69624469616d6f6e644375743a2052656d6f7665206661636574206164647260448201527f657373206d7573742062652061646472657373283029000000000000000000006064820152608490fd5b60405162461bcd60e51b815260206004820152602760248201527f4c69624469616d6f6e644375743a20496e636f727265637420466163657443756044820152663a20b1ba34b7b760c91b6064820152608490fd5b634e487b7160e01b600052602160045260246000fd5b8382604051606081016060825284518091526080820190602060808260051b8501019601916000905b828210610793576001600160a01b0386166020860152848803604086015261078587877f8faa70878671ccd212d20771b795c50af8fd3ff6cf27f4bde57e5d4de0aeb673888061077d8e866109ff565b0390a161101f565b60405160e2908161113b8239f35b848803607f19018152835180516001600160a01b03168952602081015194989394929391929060038210156106ee576040916020840152015190606060408201526020608060608301928451809452019201906000905b8082106108085750505060208060019299019201920190929161072d565b82516001600160e01b0319168452602093840193909201916001909101906107ea565b60209060409a98999a5161083e816108f7565b600081526000838201526060604082015282828d0101520198979698610120565b606460405162461bcd60e51b815260206004820152602060248201527f4261727a3a20496e76616c696420566572696669636174696f6e2046616365746044820152fd5b90506020813d6020116108e3575b816108be60209383610943565b810103126108de57516001600160e01b0319811681036108de57386100f7565b600080fd5b3d91506108b1565b6040513d6000823e3d90fd5b606081019081106001600160401b0382111761091257604052565b634e487b7160e01b600052604160045260246000fd5b604081019081106001600160401b0382111761091257604052565b601f909101601f19168101906001600160401b0382119082101761091257604052565b51906001600160a01b03821682036108de57565b6001600160401b03811161091257601f01601f191660200190565b60005b8381106109a85750506000910152565b8181015183820152602001610998565b8051156109c55760200190565b634e487b7160e01b600052603260045260246000fd5b8051600110156109c55760400190565b80518210156109c55760209160051b010190565b90602091610a1881518092818552858086019101610995565b601f01601f1916010190565b6000198114610a335760010190565b634e487b7160e01b600052601160045260246000fd5b15610a5057565b60405162461bcd60e51b815260206004820152602b60248201527f4c69624469616d6f6e644375743a204e6f2073656c6563746f727320696e206660448201526a1858d95d081d1bc818dd5d60aa1b6064820152608490fd5b15610ab057565b60405162461bcd60e51b815260206004820152602c60248201527f4c69624469616d6f6e644375743a204164642066616365742063616e2774206260448201526b65206164647265737328302960a01b6064820152608490fd5b6001600160601b03908116908114610a335760010190565b60008051602061123d83398151915280548210156109c55760005260206000200190600090565b610b95604051610b58816108f7565b602481527f4c69624469616d6f6e644375743a204e657720666163657420686173206e6f20602082015263636f646560e01b60408201528261110d565b60008051602061123d83398151915280546001600160a01b038316600090815260008051602061125d833981519152602052604090206001018190559190680100000000000000008310156109125782610bf7916001610c1695019055610b22565b90919082549060031b9160018060a01b03809116831b921b1916179055565b565b91909180548310156109c557600052601c60206000208360031c019260021b1690565b6001600160e01b03198116600081815260008051602061121d83398151915260208190526040822080546001600160a01b031660a09690961b6001600160a01b031916959095179094559194939092906001600160a01b031680835260008051602061125d8339815191526020526040832080549194919068010000000000000000821015610d125796610cdc8260409798996001610cf995018155610c18565b90919063ffffffff83549160031b9260e01c831b921b1916179055565b82526020522080546001600160a01b0319169091179055565b634e487b7160e01b85526041600452602485fd5b9091906001600160a01b039081168015610fb457308114610f585763ffffffff60e01b80941660009281845260008051602061121d833981519152926020918483526040948587205460a01c9083885260008051602061125d8339815191529586865287892054926000199b8c8501948511610f4457908991888c898c89808703610ed6575b505090525050508787525087892080548015610ec2578c0190610dcf8282610c18565b63ffffffff82549160031b1b191690555588528452868681205515610df9575b5050505050509050565b60008051602061123d8339815191528054898101908111610eae57838852858552826001888a20015491808303610e7c575b5050508054988915610e685760019798990191610e4783610b22565b909182549160031b1b19169055558552528220015580388080808080610def565b634e487b7160e01b88526031600452602488fd5b610e8590610b22565b90549060031b1c16610e9a81610bf784610b22565b885285855260018789200155388281610e2b565b634e487b7160e01b88526011600452602488fd5b634e487b7160e01b8b52603160045260248bfd5b610f379784610cdc93610ef58a9487610f0b9952828a52848420610c18565b90549060031b1c60e01b97889683525220610c18565b168b52838852898b2080546001600160a01b031660a09290921b6001600160a01b031916919091179055565b873880888c898c89610dac565b634e487b7160e01b8b52601160045260248bfd5b60405162461bcd60e51b815260206004820152602e60248201527f4c69624469616d6f6e644375743a2043616e27742072656d6f766520696d6d7560448201526d3a30b1363290333ab731ba34b7b760911b6064820152608490fd5b60405162461bcd60e51b815260206004820152603760248201527f4c69624469616d6f6e644375743a2043616e27742072656d6f76652066756e6360448201527f74696f6e207468617420646f65736e27742065786973740000000000000000006064820152608490fd5b6001600160a01b038116919082156111085760008091611085604051611044816108f7565b602881527f4c69624469616d6f6e644375743a205f696e6974206164647265737320686173602082015267206e6f20636f646560c01b60408201528261110d565b83519060208501905af4913d15611100573d926110a18461097a565b936110af6040519586610943565b84523d6000602086013e5b156110c457505050565b8251156110d357825160208401fd5b6110fc60405192839263192105d760e01b845260048401526040602484015260448301906109ff565b0390fd5b6060926110ba565b505050565b3b156111165750565b60405162461bcd60e51b8152602060048201529081906110fc9060248301906109ff56fe6080604052361560aa57600080356001600160e01b03191681527f183cde5d4f6bb7b445b8fc2f7f15d0fd1d162275aded24183babbffee7cd491f60205260408120546001600160a01b03168015606c57818091368280378136915af43d82803e156068573d90f35b3d90fd5b62461bcd60e51b6080526020608452602060a4527f4469616d6f6e643a2046756e6374696f6e20646f6573206e6f7420657869737460c45260646080fd5b00fea26469706673582212203df3feea7f1aa6ea31eb82d2ad84790e47617c094ced4ce17015a8a7487295da64736f6c63430008120033183cde5d4f6bb7b445b8fc2f7f15d0fd1d162275aded24183babbffee7cd491f183cde5d4f6bb7b445b8fc2f7f15d0fd1d162275aded24183babbffee7cd4921183cde5d4f6bb7b445b8fc2f7f15d0fd1d162275aded24183babbffee7cd4920"
        let diamondCutFacetAddress = "0xcf7ed3acca5a467e9e704c703e8d87f634fb0fc9"
        let accountFacetAddress = "0xdc64a140aa3e981100a9beca4e685f962f0cf6c9"
        let verificationFacetAddress = "0x5fc8d32690cc91d4c39d9d3abcbd16989f875707"
        let entryPointAddress = "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266"
        let securityManagerAddress = "0xe7f1725e7734ce288f8367e1bb143e90bb3f0512"
        let facetRegistryAddress = "0x9fe46736679d2d9a65f0992f2272de9f3c7fa6e0"
        let ownerAttestationObject = "0xa363666d74646e6f6e656761747453746d74a068617574684461746158a4f95bc73828ee210f9fd3bbe72d97908013b0a3759e9aea3d0ae318766cd2e1ad4500000000adce000235bcc60a648b0b25f1f055030020c720eb493e167ce93183dd91f5661e1004ed8cc1be23d3340d92381da5c0c80ca5010203262001215820a620a8cfc88fd062b11eab31663e56cad95278bef612959be214d98779f645b82258204e7b905b42917570148b0432f99ba21f2e7eebe018cbf837247e38150a89f771"

        let result = Ethereum.eip4337GetAddressFromOwnerAttestationObject(factoryAddress: factoryAddress, bytecode: bytecode, diamondCutFacetAddress: diamondCutFacetAddress, accountFacetAddress: accountFacetAddress, verificationFacetAddress: verificationFacetAddress, entryPointAddress: entryPointAddress, securityManagerAddress: securityManagerAddress, facetRegistryAddress: facetRegistryAddress, ownerAttestationObject: ownerAttestationObject)
        XCTAssertEqual(result, "0xE9C377EFCE644fd54614d77C177c14148502496F")
    }

    func testEIP4337DeploymentAddress() {
        let factoryAddress = "0xd9145CCE52D386f254917e481eB44e9943F39138"
        let logicAddress = "0x5C9eb5D6a6C2c1B3EFc52255C0b356f116f6f66D"
        let ownerAddress = "0xA5a1dddEF094095AfB7b6e322dE72961DF2e1988"
        let result = Ethereum.eip4337GetDeploymentAddress(factoryAddress: factoryAddress, logicAddress: logicAddress, ownerAddress: ownerAddress)
        XCTAssertEqual(result, "0xbEaA87cEEaC906C21aaacd258FbFB87CfA3c90a8")
    }

    func testEIP4337NativeTransferAccountNotDeployed() throws {
        let input = EthereumSigningInput.with {
            $0.txMode = .userOp
            $0.chainID = Data(hexString: "05")!
            $0.nonce = Data(hexString: "00")!
            $0.toAddress = "0xce642355Fa553f408C34a2650Ad2F4A1634d033a"

            $0.gasLimit = Data(hexString: "0x5580")!
            $0.maxFeePerGas = Data(hexString: "0x01952f1f85")!
            $0.maxInclusionFeePerGas = Data(hexString: "0x0f")!

            $0.userOperation = EthereumUserOperation.with {
                $0.entryPoint = "0x1306b01bC3e4AD202612D3843387e94737673F53"
                $0.accountFactory = "0x5A87209b755781cF65fEeEdd3855ade0317f4a92"
                $0.accountLogic = "0x21cc27d7db4fa19857a3702653a7a67ee30ca620"
                $0.owner = "0x78d9C32b96Bb872D66D51818227563f44e67E238"
                $0.isAccountDeployed = false

                $0.preVerificationGas = Data(hexString: "0xbc18")!
                $0.verificationGasLimit = Data(hexString: "0x073272")!
            }

            $0.privateKey = Data(hexString: "0xf9fb27c90dcaa5631f373330eeef62ae7931587a19bd8215d0c2addf28e439c8")!
            $0.transaction = EthereumTransaction.with {
                $0.transfer = EthereumTransaction.Transfer.with {
                    $0.amount = Data(hexString: "0x2386f26fc10000")!
                }
            }
        }

        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)
        let json = String(data: output.encoded, encoding: .utf8)

        XCTAssertEqual(try input.serializedData().hexString, "0a010512010018022a02558032010f3a0501952f1f85422a3078636536343233353546613535336634303843333461323635304164324634413136333464303333614a20f9fb27c90dcaa5631f373330eeef62ae7931587a19bd8215d0c2addf28e439c8520b0a090a072386f26fc100005ab9010a2a307831333036623031624333653441443230323631324433383433333837653934373337363733463533122a3078354138373230396237353537383163463635664565456464333835356164653033313766346139321a2a307832316363323764376462346661313938353761333730323635336137613637656533306361363230222a3078373864394333326239364262383732443636443531383138323237353633663434653637453233383202bc183a03073272")
        XCTAssertEqual(json, "{\"callData\":\"0xb61d27f6000000000000000000000000ce642355fa553f408c34a2650ad2f4a1634d033a000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000\",\"callGasLimit\":\"21888\",\"initCode\":\"0x5a87209b755781cf65feeedd3855ade0317f4a925fbfb9cf00000000000000000000000078d9c32b96bb872d66d51818227563f44e67e2380000000000000000000000000000000000000000000000000000000000000000\",\"maxFeePerGas\":\"6797860741\",\"maxPriorityFeePerGas\":\"15\",\"nonce\":\"0\",\"paymasterAndData\":\"0x\",\"preVerificationGas\":\"48152\",\"sender\":\"0x8ce23b8769ac01d0df0d5f47be1a38fea97f3879\",\"signature\":\"0x1560b19d17613ec8580cb0feaf7ac2953771404c5bd7830f585e5062e6ddd4b82ae3bb8dbddb659c0300e8009857b5c77501e1cfd5bbab48d03de0ea7207d07c1b\",\"verificationGasLimit\":\"471666\"}");
    }

    func testEIP4337NativeTransferAccountDeployed() throws {
        let input = EthereumSigningInput.with {
            $0.txMode = .userOp
            $0.chainID = Data(hexString: "05")!
            $0.nonce = Data(hexString: "01")!
            $0.toAddress = "0xce642355Fa553f408C34a2650Ad2F4A1634d033a"

            $0.gasLimit = Data(hexString: "0x9d55")!
            $0.maxFeePerGas = Data(hexString: "0x01a339c9e9")!
            $0.maxInclusionFeePerGas = Data(hexString: "0x0f")!

            $0.userOperation = EthereumUserOperation.with {
                $0.entryPoint = "0x1306b01bC3e4AD202612D3843387e94737673F53"
                $0.accountFactory = "0x5A87209b755781cF65fEeEdd3855ade0317f4a92"
                $0.accountLogic = "0x21cc27d7db4fa19857a3702653a7a67ee30ca620"
                $0.owner = "0x78d9C32b96Bb872D66D51818227563f44e67E238"
                $0.isAccountDeployed = true

                $0.preVerificationGas = Data(hexString: "0xb708")!
                $0.verificationGasLimit = Data(hexString: "0x0186a0")!
            }

            $0.privateKey = Data(hexString: "0xf9fb27c90dcaa5631f373330eeef62ae7931587a19bd8215d0c2addf28e439c8")!
            $0.transaction = EthereumTransaction.with {
                $0.transfer = EthereumTransaction.Transfer.with {
                    $0.amount = Data(hexString: "0x2386f26fc10000")!
                }
            }
        }

        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)
        let json = String(data: output.encoded, encoding: .utf8)

        XCTAssertEqual(try input.serializedData().hexString, "0a010512010118022a029d5532010f3a0501a339c9e9422a3078636536343233353546613535336634303843333461323635304164324634413136333464303333614a20f9fb27c90dcaa5631f373330eeef62ae7931587a19bd8215d0c2addf28e439c8520b0a090a072386f26fc100005abb010a2a307831333036623031624333653441443230323631324433383433333837653934373337363733463533122a3078354138373230396237353537383163463635664565456464333835356164653033313766346139321a2a307832316363323764376462346661313938353761333730323635336137613637656533306361363230222a30783738643943333262393642623837324436364435313831383232373536336634346536374532333828013202b7083a030186a0")
        XCTAssertEqual(json, "{\"callData\":\"0xb61d27f6000000000000000000000000ce642355fa553f408c34a2650ad2f4a1634d033a000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000\",\"callGasLimit\":\"40277\",\"initCode\":\"0x\",\"maxFeePerGas\":\"7033440745\",\"maxPriorityFeePerGas\":\"15\",\"nonce\":\"1\",\"paymasterAndData\":\"0x\",\"preVerificationGas\":\"46856\",\"sender\":\"0x8ce23b8769ac01d0df0d5f47be1a38fea97f3879\",\"signature\":\"0xaed2011e5cf267de495b38ecf86ad6f1d4c05217a99e59f47e8d52ba3d41c10144785893fa3e7c116a054999e3902fc2771064d0545148bc49f6d7c827fc7a9a1c\",\"verificationGasLimit\":\"100000\"}");
    }

    func testEIP4337ERC20TransferAccountDeployed() throws {
        let input = EthereumSigningInput.with {
            $0.txMode = .userOp
            $0.chainID = Data(hexString: "05")!
            $0.nonce = Data(hexString: "06")!
            $0.toAddress = "0x98339d8c260052b7ad81c28c16c0b98420f2b46a"

            $0.gasLimit = Data(hexString: "0xf78e")!
            $0.maxFeePerGas = Data(hexString: "0x168ad5950f")!
            $0.maxInclusionFeePerGas = Data(hexString: "0x0f")!


            $0.userOperation = EthereumUserOperation.with {
                $0.entryPoint = "0x1306b01bC3e4AD202612D3843387e94737673F53"
                $0.accountFactory = "0x5A87209b755781cF65fEeEdd3855ade0317f4a92"
                $0.accountLogic = "0x21cc27d7db4fa19857a3702653a7a67ee30ca620"
                $0.owner = "0x78d9C32b96Bb872D66D51818227563f44e67E238"
                $0.isAccountDeployed = true

                $0.preVerificationGas = Data(hexString: "0xbb10")!
                $0.verificationGasLimit = Data(hexString: "0x0186a0")!
            }

            $0.privateKey = Data(hexString: "0xf9fb27c90dcaa5631f373330eeef62ae7931587a19bd8215d0c2addf28e439c8")!
            $0.transaction = EthereumTransaction.with {
                $0.erc20Transfer = EthereumTransaction.ERC20Transfer.with {
                    $0.to = "0xce642355Fa553f408C34a2650Ad2F4A1634d033a"
                    $0.amount = Data(hexString: "0x0186a0")!
                }
            }
        }

        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)
        let json = String(data: output.encoded, encoding: .utf8)

        XCTAssertEqual(json, "{\"callData\":\"0xb61d27f600000000000000000000000098339d8c260052b7ad81c28c16c0b98420f2b46a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000ce642355fa553f408c34a2650ad2f4a1634d033a00000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000\",\"callGasLimit\":\"63374\",\"initCode\":\"0x\",\"maxFeePerGas\":\"96818533647\",\"maxPriorityFeePerGas\":\"15\",\"nonce\":\"6\",\"paymasterAndData\":\"0x\",\"preVerificationGas\":\"47888\",\"sender\":\"0x8ce23b8769ac01d0df0d5f47be1a38fea97f3879\",\"signature\":\"0xd006c93d6a8753b5e7c1e6349de0dea34eab2e7a533106e0f2e1a3a3b013c8e97b007546dab9d7b8fc471ad14ff2e8aa351dc4f1ecb63bf20f33858dc7366cbe1c\",\"verificationGasLimit\":\"100000\"}");
    }

    func testEIP4337ERC20ApproveAccountDeployed() throws {
        let input = EthereumSigningInput.with {
            $0.txMode = .userOp
            $0.chainID = Data(hexString: "05")!
            $0.nonce = Data(hexString: "09")!
            $0.toAddress = "0x98339d8c260052b7ad81c28c16c0b98420f2b46a"

            $0.gasLimit = Data(hexString: "0xf78e")!
            $0.maxFeePerGas = Data(hexString: "0x168ad5950f")!
            $0.maxInclusionFeePerGas = Data(hexString: "0x0f")!

            $0.userOperation = EthereumUserOperation.with {
                $0.entryPoint = "0x1306b01bC3e4AD202612D3843387e94737673F53"
                $0.accountFactory = "0x5A87209b755781cF65fEeEdd3855ade0317f4a92"
                $0.accountLogic = "0x21cc27d7db4fa19857a3702653a7a67ee30ca620"
                $0.owner = "0x78d9C32b96Bb872D66D51818227563f44e67E238"
                $0.isAccountDeployed = true

                $0.preVerificationGas = Data(hexString: "0xbb10")!
                $0.verificationGasLimit = Data(hexString: "0x0186a0")!
            }

            $0.privateKey = Data(hexString: "0xf9fb27c90dcaa5631f373330eeef62ae7931587a19bd8215d0c2addf28e439c8")!
            $0.transaction = EthereumTransaction.with {
                $0.erc20Approve = EthereumTransaction.ERC20Approve.with {
                    $0.spender = "0xce642355Fa553f408C34a2650Ad2F4A1634d033a"
                    $0.amount = Data(hexString: "0x0186a0")!
                }
            }
        }

        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)
        let json = String(data: output.encoded, encoding: .utf8)

        XCTAssertEqual(json, "{\"callData\":\"0xb61d27f600000000000000000000000098339d8c260052b7ad81c28c16c0b98420f2b46a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b3000000000000000000000000ce642355fa553f408c34a2650ad2f4a1634d033a00000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000\",\"callGasLimit\":\"63374\",\"initCode\":\"0x\",\"maxFeePerGas\":\"96818533647\",\"maxPriorityFeePerGas\":\"15\",\"nonce\":\"9\",\"paymasterAndData\":\"0x\",\"preVerificationGas\":\"47888\",\"sender\":\"0x8ce23b8769ac01d0df0d5f47be1a38fea97f3879\",\"signature\":\"0x262a67dd8cf3d16a72b7809b3b5ed55e9f4c2b93eedd5a3c6be035fbbd7111164464ec933d0fdfa359e266e318f3ac22702ae428ce14fc142e4475603e6ec15e1c\",\"verificationGasLimit\":\"100000\"}");
    }

    func testEIP4337ERC721TransferAccountDeployed() throws {
        let input = EthereumSigningInput.with {
            $0.txMode = .userOp
            $0.chainID = Data(hexString: "05")!
            $0.nonce = Data(hexString: "0x0C")!
            $0.toAddress = "0xf5de760f2e916647fd766b4ad9e85ff943ce3a2b"

            $0.gasLimit = Data(hexString: "0x60B378")!
            $0.maxFeePerGas = Data(hexString: "0x168ad5950f")!
            $0.maxInclusionFeePerGas = Data(hexString: "0x0f")!

            $0.userOperation = EthereumUserOperation.with {
                $0.entryPoint = "0x1306b01bC3e4AD202612D3843387e94737673F53"
                $0.accountFactory = "0x5A87209b755781cF65fEeEdd3855ade0317f4a92"
                $0.accountLogic = "0x21cc27d7db4fa19857a3702653a7a67ee30ca620"
                $0.owner = "0x78d9C32b96Bb872D66D51818227563f44e67E238"
                $0.isAccountDeployed = true

                $0.preVerificationGas = Data(hexString: "0xC34F")!
                $0.verificationGasLimit = Data(hexString: "0x16E360")!
            }

            $0.privateKey = Data(hexString: "0xf9fb27c90dcaa5631f373330eeef62ae7931587a19bd8215d0c2addf28e439c8")!
            $0.transaction = EthereumTransaction.with {
                $0.erc721Transfer = EthereumTransaction.ERC721Transfer.with {
                    $0.from = "0x8cE23B8769ac01d0df0d5f47Be1A38FeA97F3879"
                    $0.to = "0xce642355Fa553f408C34a2650Ad2F4A1634d033a"
                    $0.tokenID = Data(hexString: "0x2A8E57")!
                }
            }
        }

        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)
        let json = String(data: output.encoded, encoding: .utf8)

        XCTAssertEqual(json, "{\"callData\":\"0xb61d27f6000000000000000000000000f5de760f2e916647fd766b4ad9e85ff943ce3a2b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000006423b872dd0000000000000000000000008ce23b8769ac01d0df0d5f47be1a38fea97f3879000000000000000000000000ce642355fa553f408c34a2650ad2f4a1634d033a00000000000000000000000000000000000000000000000000000000002a8e5700000000000000000000000000000000000000000000000000000000\",\"callGasLimit\":\"6337400\",\"initCode\":\"0x\",\"maxFeePerGas\":\"96818533647\",\"maxPriorityFeePerGas\":\"15\",\"nonce\":\"12\",\"paymasterAndData\":\"0x\",\"preVerificationGas\":\"49999\",\"sender\":\"0x8ce23b8769ac01d0df0d5f47be1a38fea97f3879\",\"signature\":\"0x5951cc161a4d60d6b59503efb93e446f5d1a2e3a41d4503ba6393bcf2a2637340d0a865ed5d4d7650a68cbb95915eaa7ed54fd2c42b4bf7c83376f5c5d70691d1b\",\"verificationGasLimit\":\"1500000\"}");
    }

    func testEIP4337ERC1155TransferAccountDeployed() throws {
        let input = EthereumSigningInput.with {
            $0.txMode = .userOp
            $0.chainID = Data(hexString: "05")!
            $0.nonce = Data(hexString: "0x")!
            $0.toAddress = "0x428ce4b916332e1afccfddce08baecc97cb40b12"

            $0.gasLimit = Data(hexString: "0x60B378")!
            $0.maxFeePerGas = Data(hexString: "0x168ad5950f")!
            $0.maxInclusionFeePerGas = Data(hexString: "0x0f")!

            $0.userOperation = EthereumUserOperation.with {
                $0.entryPoint = "0x1306b01bC3e4AD202612D3843387e94737673F53"
                $0.accountFactory = "0x76627b8D1E01fAF0C73B69625BC1fCb8FA19a2AD"
                $0.accountLogic = "0x510ab68bd111ce7115df797118b0334d727d564b"
                $0.owner = "0x78d9C32b96Bb872D66D51818227563f44e67E238"
                $0.isAccountDeployed = true

                $0.preVerificationGas = Data(hexString: "0xC738")!
                $0.verificationGasLimit = Data(hexString: "0x16E360")!
            }

            $0.privateKey = Data(hexString: "0xf9fb27c90dcaa5631f373330eeef62ae7931587a19bd8215d0c2addf28e439c8")!
            $0.transaction = EthereumTransaction.with {
                $0.erc1155Transfer = EthereumTransaction.ERC1155Transfer.with {
                    $0.from = "0x8c560E00680b973645900528EDe71a99b8d4dca8"
                    $0.to = "0xce642355Fa553f408C34a2650Ad2F4A1634d033a"
                    $0.tokenID = Data(hexString: "0x01")!
                    $0.value = Data(hexString: "0x")!
                    $0.data = Data(hexString: "0x")!
                }
            }
        }

        let output: EthereumSigningOutput = AnySigner.sign(input: input, coin: .ethereum)
        let json = String(data: output.encoded, encoding: .utf8)

        XCTAssertEqual(json, "{\"callData\":\"0xb61d27f6000000000000000000000000428ce4b916332e1afccfddce08baecc97cb40b120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c4f242432a0000000000000000000000008c560e00680b973645900528ede71a99b8d4dca8000000000000000000000000ce642355fa553f408c34a2650ad2f4a1634d033a0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\"callGasLimit\":\"6337400\",\"initCode\":\"0x\",\"maxFeePerGas\":\"96818533647\",\"maxPriorityFeePerGas\":\"15\",\"nonce\":\"0\",\"paymasterAndData\":\"0x\",\"preVerificationGas\":\"51000\",\"sender\":\"0x8c560e00680b973645900528ede71a99b8d4dca8\",\"signature\":\"0xaae38bcf9f946921541b44c2a66596968beecb9420471e2c9c531f758a2d652930ffdeeab95742e57e8520fb5c8ca4fee6a8e47e37336d4201fe104103f85e111c\",\"verificationGasLimit\":\"1500000\"}");
    }
}
